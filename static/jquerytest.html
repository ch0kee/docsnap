<html>
  <head>
    <title>DocSnap Multi-User Document Editor</title>
    <link rel="stylesheet" type="text/css" href="screen.css"/>
    <link rel="stylesheet" type="text/css" href="styles.css"/>
    <script src="/docsnap.js"> </script>
    <script type="text/javascript" src="jquery-1.9.1.js"></script>

<script type="text/javascript">
$(document).ready(function() {

node = document.getElementById('caretspan2');
range = document.createRange();
range.selectNodeContents(node);
window.getSelection().addRange(range);

  var enableAJAXheartbeat = false;

  function caretPosition(pos) {
    var editor = document.getElementById("editor");
    $("#editor").focus(); //? kell ez ?
    var sel = window.getSelection();
    if (arguments.length == 0) {
      //get caret pos
      var cp = new Object();
      var range = sel.getRangeAt(0);
      var startContainer = range.startContainer;
      cp.index = 0;
      if (startContainer == editor) {
        cp.index = -1;
      }
      else {
        for(var child = editor.firstChild; child != startContainer; child = child.nextSibling)
          cp.index = cp.index + 1;
      }
      cp.offset = range.startOffset
      return cp;
    } else {
      //set caret pos
      var range = document.createRange();
      range.setStart(editor.childNodes[0], pos);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }
  }


  function filterEditorText() {
    var html = $("#editor").html();


    /*
    var v = $("#editor").text();
    //csak ezek a karakterek maradhatnak
    var patt = /([^a-z0-9\s;&\+=-])/gi;
    var vn = v.replace(patt,"");
    $("#editor").text( vn );
    return vn;*/
  }
  //on changed
  var suppressInput = false;
  $("#editor").on('input', function() {
    if (suppressInput)
      return;
    suppressInput = true;
    //embedIntoSpan();
//    filterEditorText();
    //caretPosition(0);

    suppressInput = false;
  });
  /*
  $("#editor").keypress(function(event) {
    if ( event.which == 13 ) {
      event.preventDefault();
    }
    xTriggered++;
    var msg = "Handler for .keypress() called " + xTriggered + " time(s).";
    $.print( msg, "html" );
    $.print( event );
  });

  function embedIntoSpan() {
  var xTriggered = 0;

    //a kurzort betesszük egy spanba
  }*/

  //input handlers
  /* insert/change attól függően, hogy volt-e kijelölés
  - onpaste
  - onkeydown ? onkeypress ?
  - ondrop
  - oncut (remove)
  - ondrag (remove)
  - onselect kellhet
  */
/*
  setInterval(function() {
      var cp = caretPosition();
    $("#caretchildindex").text( cp.index );
    $("#caretoffset").text( cp.offset );
  }, 1000);
*/
  //ajax heartbeat
  if (enableAJAXheartbeat)
  setInterval(function() {
      var syncobj = new Object();
      syncobj.content = $("#editor").text();

      $.ajax({
          url     : "/cupdate",
          type    : "POST",
          dataType: "json",
          cache   : false,
          data    : {
              d: JSON.stringify(syncobj)
          },
          success : function(json) {

          },
          error : function( xhr, status ) {
              //alert("Sorry, there was a problem!");
          },
          // code to run regardless of success or failure
          complete : function( xhr, status ) {
              //alert("The request is complete!");
          }
      });
  }, 5000);
 });
</script>
  </head>
  <body>
    <div id="content">
<h1>[DocSnap Fejléc]</h1>
<h1>DocSnap Eszköztár</h1>
<p>childIndex </p><div id="caretchildindex">X</div>
<p>childOffset </p><div id="caretoffset">X</div> <br/>
<div id="editor" class="editorinput" contenteditable="true"> </div>
<div id="editor2" class="editorinput" contenteditable="true" >
<span id="caretspan2" style="background-color: #ffaacc" data-version="1"></span>
</div>
<div id="editor3" class="editorinput" contenteditable="true" >
<span style="background-color: #ffaacc" data-version="1">xxx</span><span  style="background-color: #aaffcc" data-version="1">yyy</span>

</div>


    </div>
  </body>
</html>

