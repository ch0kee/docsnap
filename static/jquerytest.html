<html>
  <head>
    <title>DocSnap Multi-User Document Editor</title>
    <link rel="stylesheet" type="text/css" href="screen.css"/>
    <link rel="stylesheet" type="text/css" href="styles.css"/>
    <script src="/docsnap.js"> </script>
    <script src="diff.js"> </script>
    <script src="jquery-1.9.1.js"></script>
    <script src="jquerypp/jquerypp.js"> </script>

    <script type="text/javascript">

function pasteHtmlAtCaret(html) {
    var sel, range;
    if (window.getSelection) {
        // IE9 and non-IE
        sel = window.getSelection();
        if (sel.getRangeAt && sel.rangeCount) {
            range = sel.getRangeAt(0);
            range.deleteContents();

            // Range.createContextualFragment() would be useful here but is
            // non-standard and not supported in all browsers (IE9, for one)
            var el = document.createElement("div");
            el.innerHTML = html;
            var frag = document.createDocumentFragment(), node, lastNode;
            while ( (node = el.firstChild) ) {
                lastNode = frag.appendChild(node);
            }
            range.insertNode(frag);

            // Preserve the selection
            if (lastNode) {
                range = range.cloneRange();
                range.setStartAfter(lastNode);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
    } else if (document.selection && document.selection.type != "Control") {
        // IE < 9
        document.selection.createRange().pasteHTML(html);
    }
}

$(document).ready(function() {
    setInterval(function() {
        $('#preview').text( $('#editor').html());
        }, 2000);

    var sel = new Object();



    function wrapCaretWithSpan() {
        var sel = window.getSelection();
        if (sel.rangeCount <= 0)
            return;
        removeCaretSpan();
        var range = sel.getRangeAt(0);
        var span = document.createElement("span");
        span.setAttribute("id", "caretspan");
        range.surroundContents(span);
        sel.selectAllChildren(span);
        //sel.removeAllRanges();
        //sel.addRange(range);
    }

    function jumpToCaretSpan() {
        $('#editor').focus();
        var sel = window.getSelection();
        var span = document.getElementById("caretspan");
        if (span) {
            sel.selectAllChildren(span);
        }
    }

    function    removeCaretSpan() {
        if ($('#caretspan').length > 0) {
            if ($('#caretspan').contents().length > 0) {
                $('#caretspan').contents().unwrap();
            } else {
                $('#caretspan').remove();
            }
        }
    }

    //változtatások alkalmazása
    function getWithChangesApplied(str, changes) {
        var strArray = new Array();
        //index szerint rendezve
        changes.sort( function(c1, c2) {
            return c1.idx-c2.idx
        });

        var newStr = str.slice(0);
        var strIndex = 0;
        var oldIndex = 0;
        for(var i = 0; i < changes.length; ++i) {
            if (changes.typ == "+") {
            //insert
                changes.idx
            } else if (changes.typ == "-") {
            //remove
                //
            }
        }

        return str;
    }

    var savedContent = "";
    $("#test1btn").text('save content');
    $("#test1btn").mousedown(function(e) {
        e.preventDefault();
        savedContent = $('#editor').html();

    });

    var syncobjdiff = null;
    $("#test2btn").text('diff');
    $("#test2btn").mousedown(function(e) {
        e.preventDefault();
        var newContent  = $('#editor').html();
        syncobjdiff = JsDiff.diffCharChanges(savedContent, newContent);
        //console.log(JSON.stringify(syncobj));
        $('#diffview').text(JSON.stringify(syncobjdiff));
    });

    var diffViewContent = "";
    var newContent = "";
    $("#test3btn").text('merge to diffview');
    $("#test3btn").mousedown(function(e) {
        e.preventDefault();
        var oldContent = $('#diffview').html();
        newContent  = $('#editor').html();

        var changes = JsDiff.diffCharChanges(oldContent, newContent);
        var applied = JsDiff.applyCharChanges1(oldContent, changes);
        $('#diffview').html(applied);
    });
    $("#saveselectionbtn").mousedown(function(e) {
        e.preventDefault();
        //sel = $('#editor').selection();

        wrapCaretWithSpan();
        //$('#editor').focus();
    });

    $("#restoreselectionbtn").mousedown(function(e) {
        e.preventDefault();
        //$('#editor').selection(sel.start, sel.end);
        //$('#editor').focus();
        jumpToCaretSpan();
    });

    $("#editor").on({
        keypress: function(ev){

            var code = ev.keyCode || ev.which;
            /*
            console.log(ev.keyName());
            if(ev.keyName() == '\b') {
                ev.preventDefault();
            } else if (ev.keyName() == 'delete') {
                ev.preventDefault();
            } else
            */
            if (code == 13) {
                //console.log('enter pressed');
                pasteHtmlAtCaret('<br>');
                ev.preventDefault();
            }
            //console.log('keypress');
        },
/*
        input: function() {
            console.log('input');
            var sel = $('#editor').selection();
            $('#start').text(sel.start);
            $('#end').text(sel.end);
            $('#width').text(sel.width);
        }
*/
        input: function() {
            //console.log('input');
            var newContent = $("#editor").html();
            var syncobj = JsDiff.diffCharChanges(oldContent, newContent);
            //console.log(JSON.stringify(syncobj));
            oldContent = newContent;
        }
    });

    var oldContent = "";

  var enableAJAXheartbeat = false;



  function caretPosition(pos) {
    var editor = document.getElementById("editor");
    $("#editor").focus(); //? kell ez ?
    var sel = window.getSelection();
    if (arguments.length == 0) {
      //get caret pos
      var cp = new Object();
      var range = sel.getRangeAt(0);
      var startContainer = range.startContainer;
      cp.index = 0;
      if (startContainer == editor) {
        cp.index = -1;
      }
      else {
        for(var child = editor.firstChild; child != startContainer; child = child.nextSibling)
          cp.index = cp.index + 1;
      }
      cp.offset = range.startOffset
      return cp;
    } else {
      //set caret pos
      var range = document.createRange();
      range.setStart(editor.childNodes[0], pos);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }
  }


  function filterEditorText() {
    var html = $("#editor").html();


    /*
    var v = $("#editor").text();
    //csak ezek a karakterek maradhatnak
    var patt = /([^a-z0-9\s;&\+=-])/gi;
    var vn = v.replace(patt,"");
    $("#editor").text( vn );
    return vn;*/
  }
  /*
    $('#editor').bind('paste', function () {
       // clipData
    });*/

  //on changed

  /*
  $("#editor").keypress(function(event) {
    if ( event.which == 13 ) {
      event.preventDefault();
    }
    xTriggered++;
    var msg = "Handler for .keypress() called " + xTriggered + " time(s).";
    $.print( msg, "html" );
    $.print( event );
  });

  function embedIntoSpan() {
  var xTriggered = 0;

    //a kurzort betesszük egy spanba
  }*/

  //input handlers
  /* insert/change attól függően, hogy volt-e kijelölés
  - onpaste
  - onkeydown ? onkeypress ?
  - ondrop
  - oncut (remove)
  - ondrag (remove)
  - onselect kellhet
  */
    function    insertText() {
        editor = document.getElementById('editor');
        var rangeObj = document.createRange ();
        rangeObj.setStart (editor, 0);
        rangeObj.setEnd (editor, 0);
        var textNode = document.createTextNode ("alma");
        rangeObj.insertNode(textNode);
    }
/*
    $("#editor").bind('paste', function (event) {


        var range2 = document.getSelection().getRangeAt(0);
        var spanNode = document.createElement("p");
        range2.surroundContents(spanNode);
        insertText();
    });


    setInterval(function() {

        var cp = caretPosition();
        //$('#editor').text('\ud83d\udd13');
        $("#caretchildindex").text( cp.index );
        $("#caretoffset").text( cp.offset );
        $("#editor2").text( $("#editor").html() );
    }, 3000);
*/
  //ajax heartbeat
  if (enableAJAXheartbeat)
  setInterval(function() {
      var syncobj = new Object();
      syncobj.content = $("#editor").text();

      $.ajax({
          url     : "/cupdate",
          type    : "POST",
          dataType: "json",
          cache   : false,
          data    : {
              d: JSON.stringify(syncobj)
          },
          success : function(json) {

          },
          error : function( xhr, status ) {
              //alert("Sorry, there was a problem!");
          },
          // code to run regardless of success or failure
          complete : function( xhr, status ) {
              //alert("The request is complete!");
          }
      });
  }, 5000);
 });
</script>
  </head>
  <body>
    <div id="content">
<h1>[DocSnap Fejléc]</h1>
<h1>DocSnap Eszköztár</h1>
<button id="test1btn" type="button">Test1</button>
<button id="test2btn" type="button">Test2</button>
<button id="test3btn" type="button">Test3</button>
<button id="saveselectionbtn" type="button">Save Selection</button>
<button id="restoreselectionbtn" type="button">Restore Selection</button>
<table>
    <tr>
        <td>
<div id="editor" class="editorinput" contenteditable="true"> </div>
    </div>
        </td>
        <td>
    <div id="preview" class="editorinput"> </div>
        </td>
                <td>
    <div id="diffview" class="editorinput"> </div>
        </td>
    </tr>
</table>
  </body>
</html>

