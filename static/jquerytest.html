<!DOCTYPE html>
<html>file:///home/ch0kee/workspace/DocSnap/static/jquerytest.html
  <head>
    <title>DocSnap Multi-User Document Editor</title>
    <link rel="stylesheet" type="text/css" href="screen.css"/>
    <link rel="stylesheet" type="text/css" href="styles.css"/>
    <script src="/docsnap.js"> </script>
    <script src="diff.js"> </script>
    <script src="jquery-1.9.1.js"></script>
    <script src="jquerypp/jquerypp.js"> </script>
    <script src="rangy-1.2.3/rangy-core.js"> </script>
    <script type="text/javascript">

//http://rangy.googlecode.com/svn/trunk/demos/core.html
function getFirstRange() {
  var sel = rangy.getSelection();
  return sel.rangeCount ? sel.getRangeAt(0) : null;
}

function pasteHtmlAtCaret(html) {
    var sel, range;
    if (window.getSelection) {
        // IE9 and non-IE
        sel = window.getSelection();
        if (sel.getRangeAt && sel.rangeCount) {
            range = sel.getRangeAt(0);
            range.deleteContents();

            // Range.createContextualFragment() would be useful here but is
            // non-standard and not supported in all browsers (IE9, for one)
            var el = document.createElement("div");
            el.innerHTML = html;
            var frag = document.createDocumentFragment(), node, lastNode;
            while ( (node = el.firstChild) ) {
                lastNode = frag.appendChild(node);
            }
            range.insertNode(frag);

            // Preserve the selection
            if (lastNode) {
                range = range.cloneRange();
                range.setStartAfter(lastNode);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
    } else if (document.selection && document.selection.type != "Control") {
        // IE < 9
        document.selection.createRange().pasteHTML(html);
    }
}

$(document).ready(function() {
    setInterval(function() {
        $('#preview').text( $('#editor').text());
        }, 200);

    $("#test1btn").text('save content');
    $("#test1btn").mousedown(function(e) {
        e.preventDefault();
        savedContent = $('#editor').html();

    });

    var syncobjdiff = null;
    $("#test2btn").text('diff');
    $("#test2btn").mousedown(function(e) {
        e.preventDefault();
        var newContent  = $('#editor').html();
        syncobjdiff = JsDiff.diffCharChanges(savedContent, newContent);
        //console.log(JSON.stringify(syncobj));
        $('#diffview').text(JSON.stringify(syncobjdiff));
    });

    var diffViewContent = "";
    var newContent = "";
    $("#test3btn").text('merge to diffview');
    $("#test3btn").mousedown(function(e) {
        e.preventDefault();
        var oldContent = $('#diffview').html();
        newContent  = $('#editor').html();

        var changes = JsDiff.diffCharChanges(oldContent, newContent);
        var applied = JsDiff.applyCharChanges1(oldContent, changes);
        $('#diffview').html(applied);
    });

    $("#editor").on({
        keypress: function(ev){
            var code = ev.keyCode || ev.which;
            console.log(code);

            //ENTER
            if (code == 13) {
//                pasteHtmlAtCaret('<br>');
              var range = getFirstRange();
              if (range) {
                var el = document.createElement('br');
                range.insertNode(el);
                //move selection after insertion
                range.setStartAfter(el);
                range.collapse(true);
                rangy.getSelection().setSingleRange(range);
                //rangy.getSelection().collapseToEnd();
              }
              ev.preventDefault();
//                ev.preventDefault();
            } else if (code == 9) {
            //TAB
              var range = getFirstRange();
              if (range) {
                var el = document.createElement("div");
                el.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;";
                var frag = document.createDocumentFragment(), node, lastNode;
                while ( (node = el.firstChild) ) {
                    lastNode = frag.appendChild(node);
                }
                range.insertNode(frag);

                if (lastNode) {
                  range.setStartAfter(lastNode);
                  range.collapse(true);
                  rangy.getSelection().setSingleRange(range);
                }
              }
              ev.preventDefault();
            }
        },
        input: function() {
            //console.log('input');
            var newContent = $("#editor").html();
            var syncobj = JsDiff.diffCharChanges(oldContent, newContent);
            //console.log(JSON.stringify(syncobj));
            oldContent = newContent;
        }
    });

    var oldContent = "";

  var enableAJAXheartbeat = false;



  function caretPosition(pos) {
    var editor = document.getElementById("editor");
    $("#editor").focus(); //? kell ez ?
    var sel = window.getSelection();
    if (arguments.length == 0) {
      //get caret pos
      var cp = new Object();
      var range = sel.getRangeAt(0);
      var startContainer = range.startContainer;
      cp.index = 0;
      if (startContainer == editor) {
        cp.index = -1;
      }
      else {
        for(var child = editor.firstChild; child != startContainer; child = child.nextSibling)
          cp.index = cp.index + 1;
      }
      cp.offset = range.startOffset
      return cp;
    } else {
      //set caret pos
      var range = document.createRange();
      range.setStart(editor.childNodes[0], pos);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }
  }


});
</script>
  </head>
  <body>
    <div id="content">
<h1>[DocSnap Fejléc]</h1>
<h1>DocSnap Eszköztár</h1>
<button id="test1btn" type="button">Test1</button>
<button id="test2btn" type="button">Test2</button>
<button id="test3btn" type="button">Test3</button>
<button id="saveselectionbtn" type="button">Save Selection</button>
<button id="restoreselectionbtn" type="button">Restore Selection</button>
<table>
    <tr>
        <td>
<div id="editor" class="editorinput" contenteditable="true"> </div>
    </div>
        </td>
        <td>
    <div id="preview" class="editorinput"> </div>
        </td>
    </tr>
</table>
  </body>
</html>

